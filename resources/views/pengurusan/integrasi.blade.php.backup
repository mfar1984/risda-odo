<x-dashboard-layout title="Integrasi">
    @php
        $maskedApiToken = $integrasi->api_token ? substr($integrasi->api_token, 0, 8) . str_repeat('*', max(strlen($integrasi->api_token) - 8, 0)) : null;
    @endphp
    
    <x-ui.page-header
        title="Integrasi"
        description="Pengurusan integrasi sistem (API & Email Configuration)"
    >

        <!-- Tab Navigation -->
        <div class="mb-8" x-data="{
            activeTab: '{{ request('tab', 'api') }}',
            showToken: false,
            init() {
                const urlParams = new URLSearchParams(window.location.search);
                const tabParam = urlParams.get('tab');
                if (tabParam) {
                    this.activeTab = tabParam;
                }
            },
            copyToken() {
                const tokenText = '{{ $integrasi->api_token }}';
                navigator.clipboard.writeText(tokenText).then(() => {
                    alert('Token berjaya disalin!');
                });
            },
            async generateToken() {
                if (confirm('Adakah anda pasti untuk generate token baru? Token lama akan tidak sah lagi.')) {
                    try {
                        const response = await fetch('{{ route('pengurusan.generate-api-token') }}', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'X-CSRF-TOKEN': '{{ csrf_token() }}'
                            }
                        });
                        const data = await response.json();
                        if (data.success) {
                            alert('Token baru berjaya dijana!');
                            location.reload();
                        }
                    } catch (error) {
                        alert('Ralat: Gagal generate token');
                    }
                }
            }
        }">
            <div class="border-b border-gray-200">
                <nav class="-mb-px flex space-x-8" aria-label="Tabs">
                    <button @click="activeTab = 'api'"
                            :class="activeTab === 'api' ? 'text-blue-600' : 'text-gray-500 hover:text-gray-700'"
                            class="whitespace-nowrap py-3 px-2 font-medium transition-colors duration-200 flex items-center gap-2"
                            :style="activeTab === 'api' ? 'font-family: Poppins, sans-serif !important; font-size: 12px !important; font-weight: 500 !important; border-bottom: 3px solid #2563eb !important; color: #2563eb !important;' : 'font-family: Poppins, sans-serif !important; font-size: 12px !important; font-weight: 500 !important; border-bottom: 3px solid transparent !important;'">
                        <span class="material-symbols-outlined" style="font-size: 16px;">api</span>
                        API Configuration
                    </button>
                    <button @click="activeTab = 'email'"
                            :class="activeTab === 'email' ? 'text-blue-600' : 'text-gray-500 hover:text-gray-700'"
                            class="whitespace-nowrap py-3 px-2 font-medium transition-colors duration-200 flex items-center gap-2"
                            :style="activeTab === 'email' ? 'font-family: Poppins, sans-serif !important; font-size: 12px !important; font-weight: 500 !important; border-bottom: 3px solid #2563eb !important; color: #2563eb !important;' : 'font-family: Poppins, sans-serif !important; font-size: 12px !important; font-weight: 500 !important; border-bottom: 3px solid transparent !important;'">
                        <span class="material-symbols-outlined" style="font-size: 16px;">mail</span>
                        Email Configuration
                    </button>
                </nav>
            </div>

            <!-- Tab Content -->
            <div class="mt-8">
                <!-- API Configuration Tab -->
                <div x-show="activeTab === 'api'" x-transition>
                    <x-ui.container class="w-full">
                        <section>
                            <header class="mb-6">
                                <h3 class="text-lg font-semibold text-gray-900" style="font-family: Poppins, sans-serif !important; font-size: 14px !important;">API Configuration</h3>
                                <p class="text-sm text-gray-600 mt-1" style="font-family: Poppins, sans-serif !important; font-size: 11px !important;">
                                    Token global untuk integrasi Mobile App dan sistem luaran. Token ini akan digunakan untuk autentikasi awal sebelum user login.
                                </p>
                            </header>

                            <!-- Success/Error Messages -->
                            @if(session('success'))
                                <x-ui.success-alert class="mb-6">
                                    {{ session('success') }}
                                </x-ui.success-alert>
                            @endif

                            @if(session('error'))
                                <x-ui.error-alert class="mb-6">
                                    {{ session('error') }}
                                </x-ui.error-alert>
                            @endif

                            <!-- API Token Card -->
                            <div class="bg-white rounded-lg shadow-sm border border-gray-200 p-6 mb-6">
                                <div class="flex items-start justify-between mb-4">
                                    <div>
                                        <h4 class="text-base font-semibold text-gray-900 mb-1" style="font-family: Poppins, sans-serif !important; font-size: 13px !important;">
                                            Global API Token
                                        </h4>
                                        <p class="text-xs text-gray-500" style="font-family: Poppins, sans-serif !important; font-size: 10px !important;">
                                            Token ini akan digunakan oleh semua aplikasi mobile
                                        </p>
                                    </div>
                                    @if($integrasi->api_token)
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-green-100 text-green-800" style="font-family: Poppins, sans-serif !important;">
                                        <span class="material-symbols-outlined mr-1" style="font-size: 14px;">check_circle</span>
                                        Aktif
                                    </span>
                                    @else
                                    <span class="inline-flex items-center px-2.5 py-1 rounded-md text-xs font-medium bg-gray-100 text-gray-600" style="font-family: Poppins, sans-serif !important;">
                                        <span class="material-symbols-outlined mr-1" style="font-size: 14px;">block</span>
                                        Tiada Token
                                    </span>
                                    @endif
                                </div>

                                <!-- Token Display -->
                                <div class="space-y-4">
                                    <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-2" style="font-family: Poppins, sans-serif !important; font-size: 12px !important;">
                                            API Token
                                        </label>
                                        <div class="flex gap-2">
                                            <div class="flex-1 relative">
                                                <input 
                                                    type="text" 
                                                    :value="showToken ? '{{ $integrasi->api_token }}' : '{{ $maskedApiToken ?? 'Tiada token' }}'"
                                                    readonly
                                                    class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm bg-gray-50 text-sm font-mono"
                                                    style="font-family: 'Courier New', monospace !important; font-size: 11px !important;"
                                                />
                                                @if($integrasi->api_token)
                                                <button 
                                                    type="button"
                                                    @click="showToken = !showToken"
                                                    class="absolute right-3 top-1/2 transform -translate-y-1/2 text-gray-400 hover:text-gray-600"
                                                    title="Toggle visibility"
                                                >
                                                    <span class="material-symbols-outlined" style="font-size: 18px;" x-show="!showToken">visibility</span>
                                                    <span class="material-symbols-outlined" style="font-size: 18px;" x-show="showToken">visibility_off</span>
                                                </button>
                                                @endif
                                            </div>
                                            @if($integrasi->api_token)
                                            <button 
                                                type="button"
                                                @click="copyToken()"
                                                class="inline-flex items-center px-4 py-2 bg-gray-600 border border-transparent rounded-md font-semibold text-xs text-white uppercase tracking-widest hover:bg-gray-700 transition"
                                                title="Copy Token"
                                            >
                                                <span class="material-symbols-outlined" style="font-size: 16px;">content_copy</span>
                                            </button>
                                            @endif
                                            <button 
                                                type="button"
                                                @click="generateToken()"
                                                class="inline-flex items-center px-4 py-2 bg-blue-600 border border-transparent rounded-md font-semibold text-xs text-white uppercase tracking-widest hover:bg-blue-700 transition"
                                            >
                                                <span class="material-symbols-outlined mr-1" style="font-size: 16px;">refresh</span>
                                                {{ $integrasi->api_token ? 'Regenerate' : 'Generate' }}
                                            </button>
                                        </div>
                                        <p class="mt-2 text-xs text-gray-500" style="font-family: Poppins, sans-serif !important; font-size: 10px !important;">
                                            ⚠️ <strong>Penting:</strong> Regenerate token akan membatalkan token lama. Pastikan update token di semua aplikasi.
                                        </p>
                                    </div>

                                    @if($integrasi->api_token)
                                    <!-- Token Info -->
                                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 pt-4 border-t border-gray-200">
                                        <div>
                                            <div class="text-xs text-gray-500 mb-1" style="font-family: Poppins, sans-serif !important;">Created At</div>
                                            <div class="text-sm font-medium text-gray-900" style="font-family: Poppins, sans-serif !important; font-size: 12px !important;">
                                                {{ $integrasi->api_token_created_at ? $integrasi->api_token_created_at->format('d M Y, H:i') : 'N/A' }}
                                            </div>
                                        </div>
                                        <div>
                                            <div class="text-xs text-gray-500 mb-1" style="font-family: Poppins, sans-serif !important;">Last Used</div>
                                            <div class="text-sm font-medium text-gray-900" style="font-family: Poppins, sans-serif !important; font-size: 12px !important;">
                                                {{ $integrasi->api_token_last_used ? $integrasi->api_token_last_used->diffForHumans() : 'Never' }}
                                            </div>
                                        </div>
                                        <div>
                                            <div class="text-xs text-gray-500 mb-1" style="font-family: Poppins, sans-serif !important;">Usage Count</div>
                                            <div class="text-sm font-medium text-gray-900" style="font-family: Poppins, sans-serif !important; font-size: 12px !important;">
                                                {{ number_format($integrasi->api_token_usage_count ?? 0) }} requests
                                            </div>
                                        </div>
                                    </div>
                                    @endif
                                </div>
                            </div>

                            <!-- Info Card -->
                            <div class="bg-blue-50 border-l-4 border-blue-400 p-4">
                                <div class="flex">
                                    <div class="flex-shrink-0">
                                        <span class="material-symbols-outlined text-blue-400" style="font-size: 20px;">info</span>
                                    </div>
                                    <div class="ml-3">
                                        <h5 class="text-sm font-semibold text-blue-900 mb-1" style="font-family: Poppins, sans-serif !important; font-size: 12px !important;">
                                            Bagaimana Token Ini Berfungsi?
                                        </h5>
                                        <div class="text-sm text-blue-700 space-y-1" style="font-family: Poppins, sans-serif !important; font-size: 11px !important;">
                                            <p>1. Mobile app guna token ini untuk autentikasi awal</p>
                                            <p>2. User login dalam app → Dapat user-specific token (Laravel Sanctum)</p>
                                            <p>3. Multi-tenancy automatic berdasarkan organisasi user yang login</p>
                                            <p>4. Token ini <strong>tidak expire</strong> melainkan anda regenerate</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </section>
                    </x-ui.container>
                </div>

                <!-- Email Configuration Tab -->
                <div x-show="activeTab === 'email'" x-transition>
                    <x-ui.container class="w-full">
                        <form method="POST" action="{{ route('pengurusan.update-integrasi-email') }}">
                            @csrf
                            @method('PUT')

                            <section>
                                <header class="mb-6">
                                    <h3 class="text-lg font-semibold text-gray-900" style="font-family: Poppins, sans-serif !important; font-size: 14px !important;">Email Configuration</h3>
                                    <p class="text-sm text-gray-600 mt-1" style="font-family: Poppins, sans-serif !important; font-size: 11px !important;">
                                        Konfigurasi SMTP untuk email notification sistem
                                    </p>
                                </header>

                                <!-- Success/Error Messages -->
                                @if(session('success'))
                                    <x-ui.success-alert class="mb-6">
                                        {{ session('success') }}
                                    </x-ui.success-alert>
                                @endif

                                @if(session('error'))
                                    <x-ui.error-alert class="mb-6">
                                        {{ session('error') }}
                                    </x-ui.error-alert>
                                @endif

                                <!-- SMTP Configuration -->
                                <div style="margin-bottom: 32px;">
                                    <h4 class="text-base font-semibold text-gray-900 mb-4" style="font-family: Poppins, sans-serif !important; font-size: 13px !important;">SMTP Settings</h4>

                                    <!-- Row 1: SMTP Host & Port -->
                                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                                        <div style="flex: 3;">
                                            <x-forms.input-label for="smtp_host" value="SMTP Host" />
                                            <x-forms.text-input
                                                id="smtp_host"
                                                name="smtp_host"
                                                type="text"
                                                class="mt-1 block w-full"
                                                value="{{ old('smtp_host', $integrasi->smtp_host) }}"
                                                placeholder="smtp.office365.com"
                                            />
                                            <x-forms.input-error class="mt-2" :messages="$errors->get('smtp_host')" />
                                        </div>
                                        <div style="flex: 1;">
                                            <x-forms.input-label for="smtp_port" value="Port" />
                                            <x-forms.text-input
                                                id="smtp_port"
                                                name="smtp_port"
                                                type="number"
                                                class="mt-1 block w-full"
                                                value="{{ old('smtp_port', $integrasi->smtp_port) }}"
                                                placeholder="587"
                                            />
                                            <x-forms.input-error class="mt-2" :messages="$errors->get('smtp_port')" />
                                        </div>
                                    </div>

                                    <!-- Row 2: Encryption & Username -->
                                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                                        <div style="flex: 1;">
                                            <x-forms.input-label for="smtp_encryption" value="Encryption" />
                                            <select id="smtp_encryption" name="smtp_encryption" class="form-select mt-1">
                                                <option value="">None</option>
                                                <option value="tls" {{ old('smtp_encryption', $integrasi->smtp_encryption) === 'tls' ? 'selected' : '' }}>TLS</option>
                                                <option value="ssl" {{ old('smtp_encryption', $integrasi->smtp_encryption) === 'ssl' ? 'selected' : '' }}>SSL</option>
                                            </select>
                                            <x-forms.input-error class="mt-2" :messages="$errors->get('smtp_encryption')" />
                                        </div>
                                        <div style="flex: 3;">
                                            <x-forms.input-label for="smtp_username" value="Username" />
                                            <x-forms.text-input
                                                id="smtp_username"
                                                name="smtp_username"
                                                type="text"
                                                class="mt-1 block w-full"
                                                value="{{ old('smtp_username', $integrasi->smtp_username) }}"
                                                placeholder="noreply@risda.gov.my"
                                            />
                                            <x-forms.input-error class="mt-2" :messages="$errors->get('smtp_username')" />
                                        </div>
                                    </div>

                                    <!-- Row 3: Password -->
                                    <div style="margin-bottom: 20px;">
                                        <x-forms.input-label for="smtp_password" value="Password (Kosongkan jika tidak mahu ubah)" />
                                        <x-forms.text-input
                                            id="smtp_password"
                                            name="smtp_password"
                                            type="password"
                                            class="mt-1 block w-full"
                                            value=""
                                            placeholder="••••••••"
                                        />
                                        <p class="mt-1 text-xs text-gray-500">Password disimpan secara selamat (encrypted)</p>
                                        <x-forms.input-error class="mt-2" :messages="$errors->get('smtp_password')" />
                                    </div>

                                    <!-- Row 4: From Email & From Name -->
                                    <div style="display: flex; gap: 20px; margin-bottom: 20px;">
                                        <div style="flex: 1;">
                                            <x-forms.input-label for="smtp_from_address" value="From Email" />
                                            <x-forms.text-input
                                                id="smtp_from_address"
                                                name="smtp_from_address"
                                                type="email"
                                                class="mt-1 block w-full"
                                                value="{{ old('smtp_from_address', $integrasi->smtp_from_address) }}"
                                                placeholder="noreply@risda.gov.my"
                                            />
                                            <x-forms.input-error class="mt-2" :messages="$errors->get('smtp_from_address')" />
                                        </div>
                                        <div style="flex: 1;">
                                            <x-forms.input-label for="smtp_from_name" value="From Name" />
                                            <x-forms.text-input
                                                id="smtp_from_name"
                                                name="smtp_from_name"
                                                type="text"
                                                class="mt-1 block w-full"
                                                value="{{ old('smtp_from_name', $integrasi->smtp_from_name) }}"
                                                placeholder="RISDA Odometer System"
                                            />
                                            <x-forms.input-error class="mt-2" :messages="$errors->get('smtp_from_name')" />
                                        </div>
                                    </div>
                                </div>

                                <!-- Action Buttons -->
                                <div class="flex items-center justify-end gap-3 mt-6">
                                    <button type="button" class="inline-flex items-center px-4 py-2 bg-gray-200 border border-transparent rounded-md font-semibold text-xs text-gray-700 uppercase tracking-widest hover:bg-gray-300 transition">
                                        <span class="material-symbols-outlined mr-2" style="font-size: 16px;">send</span>
                                        Test Connection
                                    </button>
                                    <x-buttons.primary-button type="submit">
                                        <span class="material-symbols-outlined mr-2" style="font-size: 16px;">save</span>
                                        Simpan
                                    </x-buttons.primary-button>
                                </div>
                            </section>
                        </form>
                    </x-ui.container>
                </div>
            </div>
        </div>
    </x-ui.page-header>
</x-dashboard-layout>

